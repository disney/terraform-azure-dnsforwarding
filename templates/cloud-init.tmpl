#cloud-config

packages:
  - bind9*
  - net-tools
  - ifupdown

package_update: true
package_upgrade: true
package_reboot_if_required: true

write_files:
- path: /etc/bind/named.conf.options
  owner: 'root:root'
  permissions: '0644'
  content: |
    acl vnet { ${ vnet_cidr_block }; };
    options {
      directory "/var/cache/bind";
      forward only;
      forwarders { 168.63.129.16; };
      allow-query { localhost; localnets; ${ vnet_cidr_block }; };
      querylog ${ querylog };
    };

- path: /etc/bind/named.conf.local
  owner: 'root:root'
  permissions: '0644'
  content: |
    view public {
        match-clients { vnet; };

        zone "."                { type hint; file "/etc/bind/db.root"; };
        zone "localhost"        { type master; file "/etc/bind/db.local"; };
        zone "127.in-addr.arpa" { type master; file "/etc/bind/db.127"; };
        zone "0.in-addr.arpa"   { type master; file "/etc/bind/db.0"; };
        zone "255.in-addr.arpa" { type master; file "/etc/bind/db.255"; };
    };
    
    view default {
      match-clients { vnet; };
      zone "."                { type hint; file "/etc/bind/db.root"; };
      zone "localhost"        { type master; file "/etc/bind/db.local"; };
      zone "127.in-addr.arpa" { type master; file "/etc/bind/db.127"; };
      zone "0.in-addr.arpa"   { type master; file "/etc/bind/db.0"; };
      zone "255.in-addr.arpa" { type master; file "/etc/bind/db.255"; };

      %{ for zone in dns_zones ~}
      zone "${zone}"        { type forward; forward only; forwarders { 192.168.20.1; 192.168.20.2; }; };
      %{ endfor ~}
    };

- path: /etc/apt/apt.conf.d/50unattended-upgrades
  owner: root:root
  permissions: '0644'
  content: |
    // Automatically upgrade packages from these (origin:archive) pairs
    //
    // Note that in Ubuntu security updates may pull in new dependencies
    // from non-security sources (e.g. chromium). By allowing the release
    // pocket these get automatically pulled in.
    Unattended-Upgrade::Allowed-Origins {
            "$${distro_id}:$${distro_codename}";
            "$${distro_id}:$${distro_codename}-security";
            // Extended Security Maintenance; doesn't necessarily exist for
            // every release and this system may not have it installed, but if
            // available, the policy for updates is such that unattended-upgrades
            // should also install from here by default.
            "$${distro_id}ESM:$${distro_codename}";
            "$${distro_id}:$${distro_codename}-updates";
    //      "$${distro_id}:$${distro_codename}-proposed";
    //      "$${distro_id}:$${distro_codename}-backports";
            "microsoft-ubuntu-$${distro_codename}-prod $${distro_codename}:$${distro_codename}";
    };

    // List of packages to not update (regexp are supported)
    Unattended-Upgrade::Package-Blacklist {
    //      "vim";
    //      "libc6";
    //      "libc6-dev";
    //      "libc6-i686";
    };

    // This option will controls whether the development release of Ubuntu will be
    // upgraded automatically.
    Unattended-Upgrade::DevRelease "false";

    // This option allows you to control if on a unclean dpkg exit
    // unattended-upgrades will automatically run
    //   dpkg --force-confold --configure -a
    // The default is true, to ensure updates keep getting installed
    //Unattended-Upgrade::AutoFixInterruptedDpkg "false";

    // Split the upgrade into the smallest possible chunks so that
    // they can be interrupted with SIGTERM. This makes the upgrade
    // a bit slower but it has the benefit that shutdown while a upgrade
    // is running is possible (with a small delay)
    //Unattended-Upgrade::MinimalSteps "false";

    // Install all unattended-upgrades when the machine is shutting down
    // instead of doing it in the background while the machine is running
    // This will (obviously) make shutdown slower
    //Unattended-Upgrade::InstallOnShutdown "true";

    // Send email to this address for problems or packages upgrades
    // If empty or unset then no email is sent, make sure that you
    // have a working mail setup on your system. A package that provides
    // 'mailx' must be installed. E.g. "user@example.com"
    //Unattended-Upgrade::Mail "root";

    // Set this value to "true" to get emails only on errors. Default
    // is to always send a mail if Unattended-Upgrade::Mail is set
    //Unattended-Upgrade::MailOnlyOnError "true";

    // Remove unused automatically installed kernel-related packages
    // (kernel images, kernel headers and kernel version locked tools).
    //Unattended-Upgrade::Remove-Unused-Kernel-Packages "false";

    // Do automatic removal of new unused dependencies after the upgrade
    // (equivalent to apt-get autoremove)
    Unattended-Upgrade::Remove-Unused-Dependencies "true";

    // Automatically reboot *WITHOUT CONFIRMATION*
    //  if the file /var/run/reboot-required is found after the upgrade
    Unattended-Upgrade::Automatic-Reboot "true";

    // If automatic reboot is enabled and needed, reboot at the specific
    // time instead of immediately
    //  Default: "now"
    //Unattended-Upgrade::Automatic-Reboot-Time "02:00";

    // Use apt bandwidth limit feature, this example limits the download
    // speed to 70kb/sec
    //Acquire::http::Dl-Limit "70";

    // Enable logging to syslog. Default is False
    // Unattended-Upgrade::SyslogEnable "false";

    // Specify syslog facility. Default is daemon
    // Unattended-Upgrade::SyslogFacility "daemon";

    // Download and install upgrades only on AC power
    // (i.e. skip or gracefully stop updates on battery)
    // Unattended-Upgrade::OnlyOnACPower "true";

    // Download and install upgrades only on non-metered connection
    // (i.e. skip or gracefully stop updates on a metered connection)
    // Unattended-Upgrade::Skip-Updates-On-Metered-Connections "true";

- path: /etc/apt/apt.conf.d/50unattended-upgrades
  owner: root:root
  permissions: '0644'
  content: |
    APT::Periodic::Update-Package-Lists "1";
    APT::Periodic::Download-Upgradeable-Packages "1";
    APT::Periodic::AutocleanInterval "7";
    APT::Periodic::Unattended-Upgrade "1";

runcmd:
  - ifconfig lo:0 ${ frontend_ip } netmask 255.255.255.255 up
  - wget https://www.internic.net/domain/named.root -O /etc/bind/db.root
  - chown root:root /etc/bind/db.root && chmod 0644 /etc/bind/db.root
  - echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
  - echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf
  - echo "net.ipv6.conf.lo.disable_ipv6 = 1" >> /etc/sysctl.conf
  - sysctl -p
  - mv /etc/bind/named.conf.default-zones /etc/bind/named.conf.default-zones.orig
  - touch /etc/bind/named.conf.default-zones
  - systemctl enable bind9.service
  - systemctl restart bind9.service
